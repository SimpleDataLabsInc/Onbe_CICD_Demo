name: Run `dbt` via GitHub Actions
on:
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize]
  push:
    branches:
      - dev-gha

jobs:
  run_dbt_tests:
    name: Run DBT tests
    runs-on: ubuntu-latest
    steps:
      - name: 'Install system libs'
        env:
          DEBIAN_FRONTEND: noninteractive
          APT_GET_BE_QUIET: '-qq -o quiet::NoProgress=true -o Dpkg::Use-Pty=0'
        run: |
          sudo apt-get $APT_GET_BE_QUIET update && \
            sudo apt-get $APT_GET_BE_QUIET install \
              libbz2-dev \
              liblzma-dev \
              libreadline-dev
      - uses: actions/checkout@v4.2.2
      - name: 'Install asdf'
        uses: ynab/asdf-action@v1.2
        with:
          version: 0.16.1
        env:
          WGETRC: ${{ github.workspace }}/.wgetrc
      - name: 'Install Python via `asdf`'
        id: asdf
        run: |
          asdf plugin add python https://github.com/asdf-community/asdf-python
          asdf install python
          asdf current python
      # - run: echo "${{ steps.asdf.outputs.result }}"
      - name: 'Install `pipenv`'
        run: pip install 'pipenv==v2024.4.1' --user
      - name: 'Install `dbt`, etc. via `pipenv`'
        run: pipenv install
      - name: 'Test the connection'
        run: |
          {
            echo "DBT_USER=${DBT_USER}"
            echo "DBT_PASSWORD=${DBT_PASSWORD}"
            echo "DBT_TARGET=${DBT_TARGET}"
            echo "DBT_PROFILE=${DBT_PROFILE}"
            echo "DBT_PROFILES_DIR=${DBT_PROFILES_DIR}"
          } > .env
          pipenv run dbt debug --connection
        env:
          DBT_USER: ${{ secrets.DBT_USER }}
          DBT_PASSWORD: ${{ secrets.DBT_PASSWORD }}
          DBT_TARGET: dev  # ${{ github.base_ref }}
          DBT_PROFILE: snowflake
          DBT_PROFILES_DIR: ${{ github.workspace }}
      - name: 'Run the tests'
        id: dbt-test
        run: pipenv run dbt test
      - name: 'Show the result'
        if: ${{ always() }}
        run: echo "${{ steps.dbt-test.outputs.result }}"
        shell: bash
